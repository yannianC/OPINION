# 自动对冲功能 - 使用说明

## 快速开始

### 步骤 1: 配置主题

1. 打开前端页面
2. 点击"修改配置"按钮
3. 对每个想要对冲的主题:
   - 打开 Switch 开关（启用）
   - 设置权重（可选）
   - 保存

示例配置:
```
Trending: Will Satoshi move any Bitcoin in 2025?
Switch: [✓ 启用]
权重: 100
```

### 步骤 2: 设置监听浏览器

在"自动对冲"功能块中，为每个启用的主题输入监听浏览器ID:

```
Will Satoshi move any Bitcoin in 2025?         [📋 日志]
监听深度浏览器ID: [4001____]
```

### 步骤 3: 设置对冲数量

```
累计对冲数量: 0
总数量: [30000____] [更新对冲数量]
```

输入总数量后点击"更新对冲数量"。

### 步骤 4: 选择模式

```
模式: [○ 开仓]  或  [● 平仓]
```

默认为开仓。根据需求切换。

### 步骤 5: 启动自动分配

点击"开始自动分配"按钮。系统将:
- 每30秒执行一次检查
- 自动提交 type=3 任务
- 监控价格并自动对冲

## 监控界面说明

### 主题显示区域

每个启用的主题会显示两部分信息:

#### 左侧: Type 3 任务
```
┌──────────────────────┐
│ Type 3 任务          │
├──────────────────────┤
│ 任务 #76             │
│ 浏览器: 4001         │
│ [成功]               │
│ 2025-11-26 14:46:36  │
│ 数据: YES;99.5 ¢,... │
└──────────────────────┘
```

显示最新的 type=3 任务数据（订单簿深度）。

#### 右侧: 对冲信息
```
┌────────────────────────┐
│ 对冲信息               │
├────────────────────────┤
│ 对冲 #1764140705536    │
│ [进行中]               │
│                        │
│ YES: 4001 [成功]       │
│ NO: 4002 [进行中]      │
│ 数量: 100  价格: 99.4  │
│ 2025-11-26 14:30:00    │
└────────────────────────┘
```

显示当前正在执行的对冲任务。

## 自动对冲触发条件

系统会自动判断以下条件：

1. **任务成功**: type=3 任务 status = 2
2. **时间限制**: 任务更新时间 < 2分钟
3. **价格差值**: 买一卖一差值 > 0.1 ¢
4. **数量限制**: 累计对冲数量 < 总数量

**全部满足时自动触发对冲！**

## 价格计算逻辑

### 无子主题示例

```
Type 3 返回: YES;99.5 ¢,82580.51,81754.71;98.9 ¢,1559765.51,1542608.09
                   ↑                         ↑
              第一组第一个               第二组第一个
              
价格1 = 99.5 ¢
价格2 = 98.9 ¢
差值 = 0.6 ¢  (> 0.1) ✓

订单价格 = max(99.5, 98.9) - 0.1 = 99.4 ¢
```

### 有子主题示例

```
Type 3 返回: NO;747.57,769.90,97.1 ¢;97.6 ¢,68.33,66.69
                             ↑      ↑
                        第一组最后  第二组第一个
                        
价格1 = 97.1 ¢
价格2 = 97.6 ¢
差值 = 0.5 ¢  (> 0.1) ✓

订单价格 = max(97.1, 97.6) - 0.1 = 97.5 ¢
```

## 对冲执行流程

### 阶段 1: 触发
```
条件满足 → 调用 API 获取对冲双方 → 暂停 type=3 采集
```

### 阶段 2: 第一单
```
提交第一个任务（根据 YES/NO 前缀）
     ↓
等待任务完成 (每5秒检查)
     ↓
成功 → 继续  |  失败 → 结束对冲
```

### 阶段 3: 第二单
```
提交第二个任务（另一边）
     ↓
等待任务完成
     ↓
成功/失败 → 结束对冲
```

### 阶段 4: 完成
```
保存日志 → 恢复 type=3 采集 → 清除当前对冲
```

## 对冲状态说明

### 全部成功 (绿色)
```
YES: 4001 [成功]
NO: 4002 [成功]
```
两个任务都成功完成。

### 部分失败 (红色)
```
YES: 4001 [成功]
NO: 4002 [失败]
```
一个成功，一个失败。

### 进行中 (黄色)
```
YES: 4001 [进行中]
NO: 4002 [待处理]
```
还在执行中。

## 查看对冲日志

点击主题右上角的 "📋 日志" 按钮，查看该主题的所有对冲记录：

```
┌──────────────────────────────────────────────────┐
│ 对冲日志 - Will Satoshi move any Bitcoin...     │
├──────────────────────────────────────────────────┤
│                                                  │
│ 对冲 #1764140705536  [全部成功]                 │
│ 2025-11-26 14:30:00                              │
│ ┌──────────────────────────────────────────┐    │
│ │ 模式: 开仓                                │    │
│ │ 价格: 99.4                                │    │
│ │ 数量: 100                                 │    │
│ │ 先挂: YES                                 │    │
│ │ YES浏览器: 4001 - 成功                    │    │
│ │ NO浏览器: 4002 - 成功                     │    │
│ │ 结束时间: 2025-11-26 14:32:15             │    │
│ │ 耗时: 2分钟                               │    │
│ └──────────────────────────────────────────┘    │
│                                                  │
│ [更多记录...]                                    │
│                                                  │
└──────────────────────────────────────────────────┘
```

日志包含:
- 对冲ID
- 状态（成功/失败）
- 开仓/平仓
- 价格和数量
- 先挂哪一边
- 两个浏览器的任务状态
- 开始和结束时间
- 耗时

## 手动操作

### 更新对冲数量
```
总数量: [30000____] [更新对冲数量]
```
点击按钮后立即生效。系统会根据新的总数量判断是否继续对冲。

### 清空当前已开
```
[清空当前已开]
```
将累计对冲数量重置为 0。

### 停止自动分配
```
[停止自动分配]
```
停止所有自动对冲操作。正在执行的对冲会继续完成。

## 特殊情况处理

### 对冲执行期间
- ✅ 该主题的 type=3 任务**暂停采集**
- ✅ 其他主题正常运行
- ✅ 对冲信息实时更新

### 超时保护
- 如果对冲超过 **20分钟** 未完成
- 系统自动结束对冲
- 恢复 type=3 采集
- 保存日志

### 第一个任务失败
- 不提交第二个任务
- 立即结束对冲
- 恢复 type=3 采集

### 数量已满
```
累计对冲数量: 30000
总数量: 30000
```
- 当累计 >= 总数量时
- 停止自动对冲
- type=3 任务继续运行

## 常见问题

### Q: 为什么对冲没有触发？

检查以下条件:
1. ✓ Switch 是否启用？
2. ✓ 监听浏览器ID 是否填写？
3. ✓ 累计数量 < 总数量？
4. ✓ type=3 任务是否成功？
5. ✓ 更新时间 < 2分钟？
6. ✓ 价格差值 > 0.1？

### Q: 对冲卡住不动？

可能情况:
- 任务正在执行中（等待）
- 已超过20分钟（自动结束）
- 刷新页面查看最新状态

### Q: 如何查看历史对冲？

点击主题的 "📋 日志" 按钮，查看所有历史记录。记录保存在浏览器本地，最多500条。

### Q: 开仓和平仓的区别？

- **开仓**: 建立新仓位
- **平仓**: 平掉现有仓位

切换模式后，系统会将 `isClose` 参数传给后端 API。

### Q: type=3 任务为什么看不到？

type=3 任务只显示在"自动对冲"功能块中，**不显示在任务列表里**。这是为了保持任务列表简洁。

## 性能优化建议

1. **合理设置监听浏览器**: 
   - 每个主题使用独立的浏览器
   - 避免多个主题共用同一个浏览器

2. **适当的总数量**:
   - 根据实际需求设置
   - 不要设置过大导致无法完成

3. **定期清理日志**:
   - 浏览器本地存储最多500条
   - 会自动清理旧记录

4. **监控运行状态**:
   - 定期查看对冲状态
   - 及时处理异常情况

## 高级用法

### 批量管理

在"修改配置"弹窗中可以批量操作:
```
- 启用/禁用多个主题
- 调整权重
- 批量保存
```

### 日志分析

对冲日志包含详细信息，可以:
- 统计成功率
- 分析平均耗时
- 评估对冲效果

### 灵活调整

根据市场情况随时:
- 切换开仓/平仓模式
- 调整总数量
- 启用/禁用特定主题

## 完整操作示例

### 示例: 设置一个完整的自动对冲

1. **添加配置**:
   ```
   Trending: Will Satoshi move any Bitcoin in 2025?
   opUrl: https://app.opinion.trade/detail?topicId=1463
   polyUrl: https://polymarket.com/event/...
   opTopicId: 1463
   权重: 100
   ```

2. **启用配置**:
   ```
   在"修改配置"中打开 Switch
   ```

3. **设置监听**:
   ```
   监听深度浏览器ID: 4001
   ```

4. **设置数量**:
   ```
   总数量: 10000
   [更新对冲数量]
   ```

5. **选择模式**:
   ```
   [○ 开仓]
   ```

6. **开始运行**:
   ```
   [开始自动分配]
   ```

7. **观察执行**:
   - type=3 任务会每30秒提交一次
   - 当价格差值 > 0.1 时自动对冲
   - 对冲信息实时显示

8. **查看结果**:
   ```
   点击 [📋 日志] 查看对冲记录
   ```

## 注意事项

⚠️ **重要提醒**:

1. 确保浏览器配置正确，否则任务会失败
2. 监控累计对冲数量，避免超出预期
3. 定期检查对冲日志，确保执行正常
4. 对冲执行期间该主题会暂停 type=3 采集
5. 超过20分钟会自动结束对冲

## 联系支持

如果遇到问题:
1. 检查浏览器控制台日志
2. 查看任务列表状态
3. 查看对冲日志详情
4. 联系技术支持

---

**祝使用愉快！** 🎉

