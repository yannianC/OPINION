<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢9-äº¤æ˜“é‡è¾¾æ ‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6c757d;
        }

        .stats span {
            font-weight: 600;
            color: #495057;
        }

        .table-container {
            overflow-x: auto;
            max-height: calc(100vh - 250px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            position: relative;
            user-select: none;
        }

        th.sortable {
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding-right: 35px;
        }

        th.sortable:hover {
            background-color: #e9ecef;
        }

        th.sortable::after {
            content: 'â‡…';
            font-size: 16px;
            color: #adb5bd;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: normal;
        }

        th.sort-asc::after {
            content: 'â–²';
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        th.sort-desc::after {
            content: 'â–¼';
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #212529;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-0 {
            background: #d4edda;
            color: #155724;
        }

        .status-1 {
            background: #f8d7da;
            color: #721c24;
        }

        .volume {
            font-weight: 600;
            color: #495057;
        }

        .index {
            text-align: center;
            color: #6c757d;
            font-weight: 500;
            width: 60px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
            background: #f8d7da;
            margin: 20px;
            border-radius: 6px;
        }

        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .export-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            margin-left: 10px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-result {
            margin: 20px 30px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            display: none;
        }

        .export-result.show {
            display: block;
        }

        .export-result h3 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 16px;
        }

        .export-result-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            word-break: break-all;
            color: #212529;
            font-size: 14px;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            margin-left: 15px;
            gap: 15px;
            font-size: 14px;
            color: #495057;
        }

        .filter-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .filter-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .filter-option label {
            cursor: pointer;
            margin: 0;
        }

        .blacklist-mark {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 6px;
            background: #ff6b6b;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            vertical-align: middle;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .cancel-blacklist-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .cancel-blacklist-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }

        .cancel-blacklist-btn:active {
            transform: translateY(0);
        }

        .cancel-blacklist-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-cell {
            text-align: center;
            width: 100px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 500px;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
        }

        .toast.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out forwards;
        }

        .summary-row {
            background: #e7f3ff;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
        }

        .summary-row td {
            padding: 15px;
            color: #495057;
            font-size: 15px;
        }

        .summary-label {
            text-align: center;
            color: #667eea;
        }

        .settings-panel {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .settings-panel label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-right: 8px;
        }

        .settings-panel input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            width: 120px;
            transition: border-color 0.3s ease;
        }

        .settings-panel input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .update-btn:active {
            transform: translateY(0);
        }

        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .mark-input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            width: 120px;
            transition: border-color 0.3s ease;
        }

        .mark-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
 
        
        <div class="settings-panel">
            <div class="settings-item">
                <label>ä¸‹å•æ¬¡æ•°ï¼š</label>
                <input type="number" id="judgeCount" min="0" step="1" placeholder="è¯·è¾“å…¥">
            </div>
            <div class="settings-item">
                <label>ç´¯è®¡æˆäº¤ï¼š</label>
                <input type="number" id="judgeVolume" min="0" step="0.01" placeholder="è¯·è¾“å…¥">
            </div>
            <button class="update-btn" id="updateJudgeBtn" onclick="updateJudgeParams()">
                âœï¸ ä¿®æ”¹
            </button>
            <div class="settings-item" style="margin-left: 30px;">
                <label>æµè§ˆå™¨å ç”¨æ—¶é—´ï¼š</label>
                <input type="number" id="maxWaitTime" min="0" step="1" placeholder="è¾“å…¥ï¼ˆåˆ†é’Ÿï¼‰">
            </div>
            <button class="update-btn" id="updateWaitTimeBtn" onclick="updateMaxWaitTime()">
                âœï¸ ä¿®æ”¹
            </button>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button class="refresh-btn" id="refreshBtn" onclick="loadData()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
                <button class="export-btn" id="exportBtn" onclick="exportUnqualified()">
                    ğŸ“‹ å¯¼å‡ºä¸è¾¾æ ‡
                </button>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="radio" id="filterAll" name="filterType" value="all" checked onchange="toggleFilter()">
                        <label for="filterAll">å…¨éƒ¨</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filterBlacklist" name="filterType" value="blacklist" onchange="toggleFilter()">
                        <label for="filterBlacklist">é‡ç‚¹ (isBlack=0)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filterNormal" name="filterType" value="normal" onchange="toggleFilter()">
                        <label for="filterNormal">æ™®é€š (isBlack=1)</label>
                    </div>
                </div>
            </div>
            <div class="stats">
                <div>æ€»è®¡: <span id="totalCount">0</span> æ¡</div>
                <div>è¾¾æ ‡: <span id="qualifiedCount">0</span> æ¡</div>
                <div>ä¸è¾¾æ ‡: <span id="unqualifiedCount">0</span> æ¡</div>
            </div>
        </div>

        <div class="export-result" id="exportResult">
            <h3>ä¸è¾¾æ ‡æµè§ˆå™¨åˆ—è¡¨ï¼š</h3>
            <div class="export-result-content" id="exportContent"></div>
        </div>

        <div class="table-container" id="tableContainer">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼šä¿å­˜åŸå§‹æ•°æ®å’Œæ’åºçŠ¶æ€
        let currentData = [];
        let accountConfigMap = {}; // å­˜å‚¨è´¦æˆ·é…ç½®æ•°æ®ï¼Œkeyä¸ºfingerprintNo
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' æˆ– 'desc'
        let filterType = 'all'; // 'all'ï¼ˆå…¨éƒ¨ï¼‰ã€'blacklist'ï¼ˆé‡ç‚¹ isBlack=0ï¼‰ã€'normal'ï¼ˆæ™®é€š isBlack=1ï¼‰

        // ä»localStorageåŠ è½½æ ‡è®°æ•°æ®
        function loadMarks() {
            try {
                const marksJson = localStorage.getItem('browserMarks');
                return marksJson ? JSON.parse(marksJson) : {};
            } catch (error) {
                return {};
            }
        }

        // ä¿å­˜æ ‡è®°åˆ°localStorage
        function saveMark(number, mark) {
            const marks = loadMarks();
            if (mark && mark.trim()) {
                marks[number] = mark.trim();
            } else {
                delete marks[number];
            }
            localStorage.setItem('browserMarks', JSON.stringify(marks));
        }

        // è·å–æ ‡è®°
        function getMark(number) {
            const marks = loadMarks();
            return marks[number] || '';
        }

        // è¯»å–æ ¡éªŒå‚æ•°
        async function loadJudgeParams() {
            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/hedge/orderCountJudge');
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    document.getElementById('judgeCount').value = result.data.count || 0;
                    document.getElementById('judgeVolume').value = result.data.volume || 0;
                } else {
                    throw new Error(result.msg || 'è¯»å–æ ¡éªŒå‚æ•°å¤±è´¥');
                }
            } catch (error) {
                showToast('è¯»å–æ ¡éªŒå‚æ•°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æ ¡éªŒå‚æ•°
        async function updateJudgeParams() {
            const updateBtn = document.getElementById('updateJudgeBtn');
            const countInput = document.getElementById('judgeCount');
            const volumeInput = document.getElementById('judgeVolume');

            const count = parseInt(countInput.value);
            const volume = parseFloat(volumeInput.value);

            // éªŒè¯è¾“å…¥
            if (isNaN(count) || count < 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¸‹å•æ¬¡æ•°ï¼ˆå¤§äºç­‰äº0çš„æ•´æ•°ï¼‰', 'error');
                return;
            }

            if (isNaN(volume) || volume < 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç´¯è®¡æˆäº¤ï¼ˆå¤§äºç­‰äº0çš„æ•°å­—ï¼‰', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            updateBtn.disabled = true;
            updateBtn.textContent = 'â³ æ›´æ–°ä¸­...';

            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/hedge/orderCountJudge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        count: count,
                        volume: volume
                    })
                });

                const result = await response.json();

                if (result.code === 0) {
                    showToast('æ›´æ–°æ ¡éªŒå‚æ•°æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.msg || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                showToast('æ›´æ–°æ ¡éªŒå‚æ•°å¤±è´¥: ' + error.message, 'error');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'âœï¸ ä¿®æ”¹';
            }
        }

        // è¯»å–æµè§ˆå™¨å ç”¨æ—¶é—´
        async function loadMaxWaitTime() {
            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/hedge/maxWaitTime');
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    document.getElementById('maxWaitTime').value = result.data.maxWaitTime || 0;
                } else {
                    throw new Error(result.msg || 'è¯»å–æµè§ˆå™¨å ç”¨æ—¶é—´å¤±è´¥');
                }
            } catch (error) {
                showToast('è¯»å–æµè§ˆå™¨å ç”¨æ—¶é—´å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æµè§ˆå™¨å ç”¨æ—¶é—´
        async function updateMaxWaitTime() {
            const updateBtn = document.getElementById('updateWaitTimeBtn');
            const waitTimeInput = document.getElementById('maxWaitTime');

            const maxWaitTime = parseInt(waitTimeInput.value);

            // éªŒè¯è¾“å…¥
            if (isNaN(maxWaitTime) || maxWaitTime < 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æµè§ˆå™¨å ç”¨æ—¶é—´ï¼ˆå¤§äºç­‰äº0çš„æ•´æ•°ï¼Œå•ä½ï¼šåˆ†é’Ÿï¼‰', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            updateBtn.disabled = true;
            updateBtn.textContent = 'â³ æ›´æ–°ä¸­...';

            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/hedge/maxWaitTime', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        maxWaitTime: maxWaitTime
                    })
                });

                const result = await response.json();

                if (result.code === 0) {
                    showToast('æ›´æ–°æµè§ˆå™¨å ç”¨æ—¶é—´æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.msg || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                showToast('æ›´æ–°æµè§ˆå™¨å ç”¨æ—¶é—´å¤±è´¥: ' + error.message, 'error');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'âœï¸ ä¿®æ”¹';
            }
        }

        // åŠ è½½è´¦æˆ·é…ç½®æ•°æ®
        async function loadAccountConfig() {
            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/boost/findAccountConfigCache');
                const result = await response.json();

                if (result.code === 0 && result.data && Array.isArray(result.data)) {
                    // å°†æ•°æ®è½¬æ¢ä¸ºMapï¼Œkeyä¸ºfingerprintNo
                    accountConfigMap = {};
                    result.data.forEach(item => {
                        if (item.fingerprintNo) {
                            accountConfigMap[item.fingerprintNo] = {
                                computeGroup: item.computeGroup || '-',
                                balance: item.balance !== null && item.balance !== undefined 
                                    ? parseFloat(item.balance).toFixed(2) 
                                    : '-'
                            };
                        }
                    });
                } else {
                    console.warn('åŠ è½½è´¦æˆ·é…ç½®å¤±è´¥:', result.msg || 'æ•°æ®æ ¼å¼é”™è¯¯');
                    accountConfigMap = {};
                }
            } catch (error) {
                console.warn('åŠ è½½è´¦æˆ·é…ç½®å¤±è´¥:', error.message);
                accountConfigMap = {};
            }
        }

        async function loadData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const tableContainer = document.getElementById('tableContainer');
            const exportResult = document.getElementById('exportResult');
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
            tableContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>';
            
            // éšè—å¯¼å‡ºç»“æœ
            exportResult.classList.remove('show');

            try {
                // å¹¶è¡ŒåŠ è½½è®¢å•æ•°æ®å’Œè´¦æˆ·é…ç½®æ•°æ®
                const [orderResponse, accountConfigPromise] = await Promise.all([
                    fetch('https://sg.bicoin.com.cn/99l/hedge/orderCount'),
                    loadAccountConfig()
                ]);

                const orderResult = await orderResponse.json();

                if (orderResult.code === 0 && orderResult.data && orderResult.data.list) {
                    currentData = orderResult.data.list;
                    // åˆå¹¶è´¦æˆ·é…ç½®æ•°æ®åˆ°currentData
                    currentData.forEach(item => {
                        const config = accountConfigMap[item.number];
                        if (config) {
                            item.computeGroup = config.computeGroup;
                            item.balance = config.balance;
                        } else {
                            item.computeGroup = '-';
                            item.balance = '-';
                        }
                    });
                    displayData(currentData);
                } else {
                    throw new Error(orderResult.msg || 'æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                tableContainer.innerHTML = `
                    <div class="error">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 12px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
            }
        }

        function toggleFilter() {
            const selectedFilter = document.querySelector('input[name="filterType"]:checked');
            filterType = selectedFilter ? selectedFilter.value : 'all';
            
            // é‡æ–°åº”ç”¨æ’åºå’Œç­›é€‰
            if (sortColumn) {
                sortData(sortColumn);
            } else {
                displayData(currentData);
            }
        }

        function sortData(column) {
            // å¦‚æœç‚¹å‡»åŒä¸€åˆ—ï¼Œåˆ‡æ¢æ’åºæ–¹å‘ï¼›å¦åˆ™è®¾ç½®ä¸ºå‡åº
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // åˆ›å»ºæ•°æ®å‰¯æœ¬è¿›è¡Œæ’åºï¼ˆå¯¹åŸå§‹æ•°æ®æ’åºï¼Œç­›é€‰ç”± displayData å¤„ç†ï¼‰
            const sortedData = [...currentData].sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'number':
                        // æµè§ˆå™¨å·ï¼šæŒ‰æ•°å­—æ’åº
                        aVal = parseInt(a.number || 0);
                        bVal = parseInt(b.number || 0);
                        break;
                    case 'count':
                        // äº¤æ˜“æ¬¡æ•°ï¼šæŒ‰æ•°å­—æ’åº
                        aVal = parseInt(a.count || 0);
                        bVal = parseInt(b.count || 0);
                        break;
                    case 'status':
                        // æ˜¯å¦è¾¾æ ‡ï¼š0è¾¾æ ‡ï¼Œ1ä¸è¾¾æ ‡ï¼ŒæŒ‰æ•°å€¼æ’åº
                        // ç¡®ä¿è½¬æ¢ä¸ºæ•°å­—ç±»å‹
                        aVal = Number(a.status);
                        bVal = Number(b.status);
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œé»˜è®¤ä¸º1ï¼ˆä¸è¾¾æ ‡ï¼‰
                        if (isNaN(aVal)) aVal = 1;
                        if (isNaN(bVal)) bVal = 1;
                        break;
                    case 'volume':
                        // äº¤æ˜“é‡ï¼šæŒ‰æ•°å­—æ’åº
                        aVal = parseFloat(a.volume || 0);
                        bVal = parseFloat(b.volume || 0);
                        break;
                    case 'computeGroup':
                        // ç”µè„‘ç»„ï¼šæŒ‰å­—ç¬¦ä¸²æ’åºï¼Œ'-' æ’åœ¨æœ€å
                        aVal = a.computeGroup || '-';
                        bVal = b.computeGroup || '-';
                        if (aVal === '-' && bVal !== '-') return 1;
                        if (aVal !== '-' && bVal === '-') return -1;
                        if (aVal === '-' && bVal === '-') return 0;
                        // å°è¯•æŒ‰æ•°å­—æ’åºï¼Œå¦‚æœä¸æ˜¯æ•°å­—åˆ™æŒ‰å­—ç¬¦ä¸²æ’åº
                        const aNum = parseFloat(aVal);
                        const bNum = parseFloat(bVal);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            aVal = aNum;
                            bVal = bNum;
                        }
                        break;
                    case 'balance':
                        // ä½™é¢ï¼šæŒ‰æ•°å­—æ’åºï¼Œ'-' æ’åœ¨æœ€å
                        const aBalanceIsEmpty = a.balance === '-' || a.balance === null || a.balance === undefined;
                        const bBalanceIsEmpty = b.balance === '-' || b.balance === null || b.balance === undefined;
                        if (aBalanceIsEmpty && !bBalanceIsEmpty) return 1;
                        if (!aBalanceIsEmpty && bBalanceIsEmpty) return -1;
                        if (aBalanceIsEmpty && bBalanceIsEmpty) return 0;
                        aVal = parseFloat(a.balance || 0);
                        bVal = parseFloat(b.balance || 0);
                        break;
                    default:
                        return 0;
                }

                if (aVal < bVal) {
                    return sortDirection === 'asc' ? -1 : 1;
                } else if (aVal > bVal) {
                    return sortDirection === 'asc' ? 1 : -1;
                } else {
                    return 0;
                }
            });

            displayData(sortedData);
        }

        function displayData(list) {
            const tableContainer = document.getElementById('tableContainer');
            
            // åº”ç”¨ç­›é€‰ï¼šæ ¹æ®ç­›é€‰ç±»å‹è¿‡æ»¤æ•°æ®
            let filteredList = list;
            if (filterType === 'blacklist') {
                // åªæ˜¾ç¤ºé‡ç‚¹æ ‡è®° (isBlack == 0)
                filteredList = list.filter(item => Number(item.isBlack) === 0);
            } else if (filterType === 'normal') {
                // åªæ˜¾ç¤ºæ™®é€š (isBlack == 1)
                filteredList = list.filter(item => Number(item.isBlack) === 1);
            }
            // filterType === 'all' æ—¶æ˜¾ç¤ºå…¨éƒ¨ï¼Œä¸éœ€è¦ç­›é€‰
            
            if (!filteredList || filteredList.length === 0) {
                tableContainer.innerHTML = '<div class="empty">æš‚æ— æ•°æ®</div>';
                updateStats(list.length, 0, 0);
                return;
            }

            // ç»Ÿè®¡æ•°æ®ï¼ˆåŸºäºåŸå§‹åˆ—è¡¨ï¼Œä¸åŸºäºç­›é€‰åçš„åˆ—è¡¨ï¼‰
            let qualifiedCount = 0;
            let unqualifiedCount = 0;
            list.forEach(item => {
                if (item.status === 0) {
                    qualifiedCount++;
                } else {
                    unqualifiedCount++;
                }
            });

            updateStats(list.length, qualifiedCount, unqualifiedCount);

            // ç”Ÿæˆè¡¨å¤´HTMLï¼Œæ·»åŠ æ’åºç±»å’Œç‚¹å‡»äº‹ä»¶
            const getSortClass = (col) => {
                if (sortColumn === col) {
                    return sortDirection === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                return '';
            };

            // è®¡ç®—æ€»è®¡ï¼šæ ¹æ®ç­›é€‰åçš„æ•°æ®è®¡ç®—äº¤æ˜“æ¬¡æ•°ã€äº¤æ˜“é‡å’Œä½™é¢æ€»å’Œ
            let totalCount = 0;
            let totalVolume = 0;
            let totalBalance = 0;
            filteredList.forEach(item => {
                totalCount += parseInt(item.count || 0);
                totalVolume += parseFloat(item.volume || 0);
                // è®¡ç®—ä½™é¢æ€»å’Œï¼Œå¿½ç•¥ '-' å€¼
                if (item.balance && item.balance !== '-') {
                    const balance = parseFloat(item.balance);
                    if (!isNaN(balance)) {
                        totalBalance += balance;
                    }
                }
            });

            // ç”Ÿæˆè¡¨æ ¼HTML
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="index">åºå·</th>
                            <th class="sortable ${getSortClass('number')}" onclick="sortData('number')">æµè§ˆå™¨</th>
                            <th class="sortable ${getSortClass('computeGroup')}" onclick="sortData('computeGroup')">ç”µè„‘ç»„</th>
                            <th class="sortable ${getSortClass('balance')}" onclick="sortData('balance')">ä½™é¢</th>
                            <th>æ ‡è®°</th>
                            <th class="sortable ${getSortClass('count')}" onclick="sortData('count')">äº¤æ˜“æ¬¡æ•°</th>
                            <th class="sortable ${getSortClass('status')}" onclick="sortData('status')">æ˜¯å¦è¾¾æ ‡</th>
                            <th class="sortable ${getSortClass('volume')}" onclick="sortData('volume')">äº¤æ˜“é‡</th>
                            <th class="action-cell">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="summary-row">
                            <td class="summary-label">æ€»è®¡</td>
                            <td><strong>${filteredList.length}</strong></td>
                            <td>-</td>
                            <td class="volume"><strong>${totalBalance.toFixed(2)}</strong></td>
                            <td>-</td>
                            <td><strong>${totalCount}</strong></td>
                            <td>-</td>
                            <td class="volume"><strong>${totalVolume.toFixed(2)}</strong></td>
                            <td>-</td>
                        </tr>
            `;

            filteredList.forEach((item, index) => {
                const statusClass = item.status === 0 ? 'status-0' : 'status-1';
                const statusText = item.status === 0 ? 'è¾¾æ ‡' : 'ä¸è¾¾æ ‡';
                const volume = parseFloat(item.volume || 0).toFixed(2);
                const computeGroup = item.computeGroup || '-';
                const balance = item.balance || '-';
                const currentMark = getMark(item.number || '');
                const number = (item.number || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // æ£€æŸ¥ isBlack å­—æ®µï¼Œå¦‚æœä¸º 0 åˆ™æ·»åŠ é‡ç‚¹æ ‡è®°
                const blacklistMark = Number(item.isBlack) === 0 
                    ? '<span class="blacklist-mark">é‡ç‚¹</span>' 
                    : '';

                // å¦‚æœ isBlack=0ï¼Œæ˜¾ç¤ºå–æ¶ˆé‡ç‚¹æŒ‰é’®
                const actionButton = Number(item.isBlack) === 0
                    ? `<button class="cancel-blacklist-btn" onclick="cancelBlacklist('${number}')">å–æ¶ˆé‡ç‚¹</button>`
                    : '';

                // è½¬ä¹‰æ ‡è®°å€¼ä¸­çš„ç‰¹æ®Šå­—ç¬¦
                const escapedMark = currentMark.replace(/"/g, '&quot;').replace(/'/g, "&#39;");

                tableHTML += `
                    <tr>
                        <td class="index">${index + 1}</td>
                        <td><strong>${item.number || '-'}</strong>${blacklistMark}</td>
                        <td>${computeGroup}</td>
                        <td>${balance}</td>
                        <td>
                            <input type="text" 
                                   class="mark-input" 
                                   value="${escapedMark}" 
                                   placeholder="è¾“å…¥æ ‡è®°"
                                   onchange="saveMark('${number}', this.value)"
                                   onblur="saveMark('${number}', this.value)">
                        </td>
                        <td>${item.count || 0}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="volume">${volume}</td>
                        <td class="action-cell">${actionButton}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        function updateStats(total, qualified, unqualified) {
            document.getElementById('totalCount').textContent = total;
            document.getElementById('qualifiedCount').textContent = qualified;
            document.getElementById('unqualifiedCount').textContent = unqualified;
        }

        function exportUnqualified() {
            if (!currentData || currentData.length === 0) {
                alert('æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåˆ·æ–°æ•°æ®');
                return;
            }

            // ç­›é€‰ä¸è¾¾æ ‡çš„æ•°æ®ï¼ˆstatus === 1ï¼‰
            const unqualifiedList = currentData
                .filter(item => Number(item.status) === 1)
                .map(item => item.number || '')
                .filter(number => number !== '');

            const exportResult = document.getElementById('exportResult');
            const exportContent = document.getElementById('exportContent');

            if (unqualifiedList.length === 0) {
                exportContent.textContent = 'æš‚æ— ä¸è¾¾æ ‡æ•°æ®';
            } else {
                // ç”¨é€—å·æ‹¼æ¥
                exportContent.textContent = unqualifiedList.join(',');
            }

            // æ˜¾ç¤ºå¯¼å‡ºç»“æœ
            exportResult.classList.add('show');

            // æ»šåŠ¨åˆ°å¯¼å‡ºç»“æœåŒºåŸŸ
            exportResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showToast(message, type = 'success') {
            // ç§»é™¤å·²å­˜åœ¨çš„ toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'âœ…' : 'âŒ';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;

            document.body.appendChild(toast);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        async function cancelBlacklist(number) {
            if (!number) {
                showToast('æµè§ˆå™¨å·ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å’Œè¡Œ
            const buttons = document.querySelectorAll('.cancel-blacklist-btn');
            let targetButton = null;
            let targetRow = null;
            
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${number}'`)) {
                    targetButton = btn;
                    targetRow = btn.closest('tr');
                }
            });

            if (targetButton) {
                targetButton.disabled = true;
                targetButton.textContent = 'å¤„ç†ä¸­...';
            }

            try {
                const response = await fetch('https://sg.bicoin.com.cn/99l/hedge/addOrderCountBlack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ number: number })
                });

                const result = await response.json();

                if (result.code === 0) {
                    showToast('å–æ¶ˆé‡ç‚¹æˆåŠŸ', 'success');
                    
                    // æ›´æ–° currentData ä¸­çš„æ•°æ®
                    const item = currentData.find(item => item.number === number);
                    if (item) {
                        item.isBlack = 1; // æ›´æ–°ä¸ºæ™®é€šçŠ¶æ€
                    }
                    
                    // æ›´æ–°å½“å‰è¡Œçš„æ˜¾ç¤ºï¼šç§»é™¤é‡ç‚¹æ ‡è®°å’ŒæŒ‰é’®
                    if (targetRow) {
                        const browserCell = targetRow.querySelector('td:nth-child(2)');
                        if (browserCell) {
                            // ç§»é™¤é‡ç‚¹æ ‡è®°
                            const blacklistMark = browserCell.querySelector('.blacklist-mark');
                            if (blacklistMark) {
                                blacklistMark.remove();
                            }
                        }
                        
                        // ç§»é™¤æŒ‰é’®
                        const actionCell = targetRow.querySelector('td:last-child');
                        if (actionCell) {
                            actionCell.innerHTML = '';
                        }
                    }
                } else {
                    throw new Error(result.msg || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                if (targetButton) {
                    targetButton.disabled = false;
                    targetButton.textContent = 'å–æ¶ˆé‡ç‚¹';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        window.addEventListener('DOMContentLoaded', () => {
            loadJudgeParams(); // åŠ è½½æ ¡éªŒå‚æ•°
            loadMaxWaitTime(); // åŠ è½½æµè§ˆå™¨å ç”¨æ—¶é—´
            loadData(); // åŠ è½½æ•°æ®ï¼ˆå†…éƒ¨ä¼šè°ƒç”¨loadAccountConfigï¼‰
        });
    </script>
</body>
</html>
